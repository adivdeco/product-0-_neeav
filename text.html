<div class="flip-card">
    <div class="flip-card-inner">
        <div class="flip-card-front">
            <div>‚ú® Favourite Tool<br>Hammer</div>
        </div>
        <div class="flip-card-back">
            <div>üèÜ Best Renovator 2023</div>
        </div>
    </div>
</div>
<style>
    .flip-card {
        background: transparent;
        width: 260px;
        height: 120px;
        perspective: 1200px;
    }

    .flip-card-inner {
        position: relative;
        width: 100%;
        height: 100%;
        transition: transform 0.8s cubic-bezier(.5, 1.5, .8, 1);
        transform-style: preserve-3d;
    }

    .flip-card:hover .flip-card-inner {
        transform: rotateY(180deg);
    }

    .flip-card-front,
    .flip-card-back {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        border-radius: 16px;
        box-shadow: 0 6px 18px #a78bfa22;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2em;
        font-weight: 600;
    }

    .flip-card-front {
        background: #f3f0ff;
    }

    .flip-card-back {
        background: #e0e7ff;
        transform: rotateY(180deg);
    }
</style>



const express = require('express');
const session = require('express-session');
const cookieParser = require('cookie-parser');
const cors = require('cors');
const http = require('http');
const { Server } = require('socket.io');
require('dotenv').config({ quiet: true });
const MongoStore = require('connect-mongo');

const main = require('./config/db');
// const { getCorsOptions } = require('./config/corsOptions');
// In server.js, after database connection
require('./utils/autoAssignCron');
console.log('Auto-assignment cron job initialized');

// Routes
const authRouter = require('./routes/userAuth');
const billsRouter = require('./routes/khata');
const ownRouter = require('./routes/useAs');
const uploadData = require('./routes/cloudData');
const WorkRoute = require('./routes/workRequests');
const NotificationRouter = require('./routes/notifications');
const employeeRouter = require('./routes/employeeRoutes');
const Airouter = require('./routes/aiPower')

const app = express();

const sessionMiddleware = session({
secret: process.env.SESSION_SECRET,
resave: false,
saveUninitialized: false,
store: MongoStore.create({
mongoUrl: process.env.DB_URL,
}),
// cookie: {
// secure: true, // mark is false it on local
// httpOnly: true,
// sameSite: "none", // mark it lax if on local
// maxAge: 30 * 24 * 60 * 60 * 1000,
// },
cookie: {
httpOnly: true,
secure: true,
sameSite: "none",
// domain: ".onrender.com",
maxAge: 30 * 24 * 60 * 60 * 1000
}


});

// --- Middleware setup ---
// app.use(cors(getCorsOptions())); // for local
app.use(cors({
origin: "https://product-2-neeav.vercel.app",
credentials: true
}));

app.use(express.json());
app.use(express.urlencoded({ extended: true }));
app.use(sessionMiddleware);
app.use(cookieParser());



// --- Register routes ---
app.get('/', (req, res) => {
res.send('‚úÖ Server is up and running');
});
app.use('/auth', authRouter);
app.use('/khata', billsRouter);
app.use('/useas', ownRouter);
app.use('/upload', uploadData);
app.use('/api/work-requests', WorkRoute);
app.use('/api/notifications', NotificationRouter);
app.use('/api/employee', employeeRouter);
app.use('/ai-build', Airouter)


// --- Create HTTP server & bind Socket.IO ---
const server = http.createServer(app);
// const allowedOrigins = process.env.CORS_ORIGINS ? process.env.CORS_ORIGINS.split(',') : [];
// const io = new Server(server, {
// cors: {
// origin: allowedOrigins,
// methods: ['GET', 'POST'],
// credentials: true,
// },
// });
const io = new Server(server, {
cors: {
origin: "https://product-2-neeav.vercel.app",
credentials: true,
}
});


global.users = new Map();
global.io = io;

// io.on('connection', (socket) => {
// console.log('User connected:', socket.id);

// socket.on('register', (userId) => {
// if (!userId) return;
// global.users.set(userId, socket.id);
// console.log(`User ${userId} registered with socket ${socket.id}`);
// });

// socket.on('disconnect', () => {
// for (const [key, value] of global.users.entries()) {
// if (value === socket.id) global.users.delete(key);
// }
// console.log('User disconnected:', socket.id);
// });
// });

// global.io = io;

// --- Start the app ---

// Add session middleware to Socket.io

// After session setup, store the middleware

io.use((socket, next) => {
sessionMiddleware(socket.request, {}, next);
});

io.on('connection', (socket) => {
console.log('User connected:', socket.id);

// Get user ID from session
const userId = socket.request.session?.userId;
console.log('Session userId:', userId);

if (userId) {
global.users.set(userId.toString(), socket.id);
console.log(`User ${userId} registered with socket ${socket.id}`);

// Join user to their personal room
socket.join(userId.toString());
}

socket.on('disconnect', () => {
if (userId) {
global.users.delete(userId.toString());
}
console.log('User disconnected:', socket.id);
});
});

// main()
// .then(() => {
// server.listen(process.env.PORT, () => {
// console.log(`üöÄ Server running with Socket.IO on port ${process.env.PORT}`);
// });
// })
// .catch((err) => {
// console.error('‚ùå Database connection failed:', err);
// });
// Add this right after your database connection in server.js

main()
.then(async () => {
// Auto-create employee records for existing admins
try {
const createEmployeeRecords = require('./utils/createEmployeeRecords');
const { cleanupOldRequests } = require('./utils/cleanupCron')

await createEmployeeRecords();
await cleanupOldRequests();

console.log('‚úÖ Employee records check completed & cleanup requist also runs.');
} catch (error) {
console.log('‚ÑπÔ∏è Employee records creation skipped or failed:', error.message);
}

server.listen(process.env.PORT, () => {
console.log(`üöÄ Server running with Socket.IO on port ${process.env.PORT}`);
});
})
.catch((err) => {
console.error('‚ùå Database connection failed:', err);
});

module.exports = app;